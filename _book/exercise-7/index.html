
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Secure your service mesh Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../exercise-8/" />
    
    
    <link rel="prev" href="../exercise-6/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">KubeCon Istio Workshop</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../exercise-1/">
            
                <a href="../exercise-1/">
            
                    
                    Accessing a cluster with IKS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="../exercise-2/">
            
                <a href="../exercise-2/">
            
                    
                    Installing Istio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="../exercise-3/">
            
                <a href="../exercise-3/">
            
                    
                    Deploy Guestbook Application
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="../exercise-4/">
            
                <a href="../exercise-4/">
            
                    
                    Metrics and Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5" data-path="../exercise-5/">
            
                <a href="../exercise-5/">
            
                    
                    Expose with Istio Gateway
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6" data-path="../exercise-6/">
            
                <a href="../exercise-6/">
            
                    
                    Traffic Management
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.1.7" data-path="./">
            
                <a href="./">
            
                    
                    Secure your service mesh
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.8" data-path="../exercise-8/">
            
                <a href="../exercise-8/">
            
                    
                    Enforce policies for microservices
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Secure your service mesh</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="exercise-7---secure-your-services">Exercise 7 - Secure your services</h1>
<h2 id="mutual-authentication-with-transport-layer-security-mtls">Mutual authentication with Transport Layer Security (mTLS)</h2>
<p>Istio can secure the communication between microservices without requiring application code changes. Security is provided by authenticating and encrypting communication paths within the cluster. This is becoming a common security and compliance requirement. Delegating communication security to Istio (as opposed to implementing TLS in each microservice), ensures that your application will be deployed with consistent and manageable security policies.</p>
<p>Istio Citadel is an optional part of Istio&apos;s control plane components. When enabled, it provides each Envoy sidecar proxy with a strong (cryptographic) identity, in the form of a certificate.
Identity is based on the microservice&apos;s service account and is independent of its specific network location, such as cluster or current IP address.
Envoys then use the certificates to identify each other and establish an authenticated and encrypted communication channel between them.</p>
<p>Citadel is responsible for:</p>
<ul>
<li><p>Providing each service with an identity representing its role.</p>
</li>
<li><p>Providing a common trust root to allow Envoys to validate and authenticate each other.</p>
</li>
<li><p>Providing a key management system, automating generation, distribution, and rotation of certificates and keys.</p>
</li>
</ul>
<p>When an application microservice connects to another microservice, the communication is redirected through the client side and server side Envoys. The end-to-end communication path is:</p>
<ul>
<li><p>Local TCP connection (i.e., <code>localhost</code>, not reaching the &quot;wire&quot;) between the application and Envoy (client- and server-side);</p>
</li>
<li><p>Mutually authenticated and encrypted connection between Envoy proxies.</p>
</li>
</ul>
<p>When Envoy proxies establish a connection, they exchange and validate certificates to confirm that each is indeed connected to a valid and expected peer. The established identities can later be used as basis for policy checks (e.g., access authorization).</p>
<h2 id="steps">Steps</h2>
<blockquote>
<p>Version 2 of the guestbook application uses an external service (tone analyzer) which is not Istio-enabled.
Thus, we will disable mTLS globally and enable it only for communication between internal cluster services in this lab.</p>
</blockquote>
<ol>
<li><p>Ensure Citadel is running</p>
<p> Citadel is Istio&apos;s in-cluster Certificate Authority (CA) and is required for generating and managing cryptographic identities in the cluster.
 Verify Citadel is running:</p>
<pre><code class="lang-shell"> kubectl get deployment -l istio=citadel -n istio-system
</code></pre>
<p> Expected output:</p>
<pre><code class="lang-shell"> NAME            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
 istio-citadel   1         1         1            1           15h
</code></pre>
</li>
<li><p>Define mTLS Authentication Policy</p>
<p> Define mTLS authentication policy for the analyzer service:</p>
<pre><code class="lang-shell"> cat &lt;&lt;EOF | kubectl create -f -
 apiVersion: authentication.istio.io/v1alpha1
 kind: Policy
 metadata:
   name: mtls-to-analyzer
   namespace: default
 spec:
   targets:
   - name: analyzer
   peers:
   - mtls:
 EOF
</code></pre>
<p> You should see:</p>
<pre><code class="lang-shell"> Created config policy/default/mtls-to-analyzer at revision 3934195
</code></pre>
<p> Confirm the policy has been created:</p>
<pre><code class="lang-shell"> kubectl get policies.authentication.istio.io
</code></pre>
<p> Output:</p>
<pre><code class="lang-shell"> NAME              AGE
 mtls-to-analyzer  1m
</code></pre>
</li>
<li><p>Enable mTLS from guestbook using a Destination rule</p>
<pre><code class="lang-shell"> cat &lt;&lt;EOF | kubectl create -f -
 apiVersion: networking.istio.io/v1alpha3
 kind: DestinationRule
 metadata:
   name: route-with-mtls-for-analyzer
   namespace: default
 spec:
   host: &quot;analyzer.default.svc.cluster.local&quot;
   trafficPolicy:
     tls:
       mode: ISTIO_MUTUAL
 EOF
</code></pre>
<p> Output:</p>
<pre><code> Created config destination-rule/default/route-with-mtls-for-analyzer at revision 3934279
</code></pre></li>
</ol>
<h2 id="verifying-the-authenticated-connection">Verifying the Authenticated Connection</h2>
<p>If mTLS is working correctly, the Guestbook app should continue to operate as expected, without any user visible impact. Istio will automatically add (and manage) the required certificates and private keys. To confirm their presence in the Envoy containers, do the following:</p>
<ol>
<li><p>Get the name of a guestbook pod. Make sure the pod is &#x201C;Running&#x201D;.</p>
<pre><code class="lang-shell"> kubectl get pods -l app=guestbook
</code></pre>
<p> Output:</p>
<pre><code class="lang-shell"> NAME                            READY     STATUS    RESTARTS   AGE
 guestbook-v2-784546fbb9-299jz   2/2       Running   0          13h
 guestbook-v2-784546fbb9-hsbnq   2/2       Running   0          13h
 guestbook-v2-784546fbb9-lcxdz   2/2       Running   0          13h
</code></pre>
</li>
<li><p>SSH into the Envoy container. Make sure to change the pod name into the corresponding one on your system. This command will execute into istio-proxy container (sidecar) of the pod.</p>
<pre><code class="lang-shell"> kubectl exec -it guestbook-v2-xxxxxxxx -c istio-proxy /bin/bash
</code></pre>
</li>
<li><p>Verify that the certificate and keys are present.</p>
<pre><code class="lang-shell"> ls /etc/certs/
</code></pre>
<p> You should see the following (plus some others):</p>
<pre><code class="lang-shell"> cert-chain.pem   key.pem   root-cert.pem
</code></pre>
<p> Note that <code>cert-chain.pem</code> is Envoy&#x2019;s public certificate (i.e., presented to the peer), and <code>key.pem</code> is the corresponding private key. The <code>root-cert.pem</code> file is Citadel&apos;s root certificate, used to verify peer certificates.</p>
</li>
<li><p>Exit the container.</p>
<p> ``shell
 exit
 ```</p>
</li>
</ol>
<h2 id="quiz">Quiz</h2>
<p><strong>True or False?</strong></p>
<ol>
<li><p>Istio Citadel provides each microservice with a strong, cryptographic, identity in the form of a certificate. The certificates&apos; life cycle is fully managed by Istio. (True)</p>
</li>
<li><p>Istio provides microservices with mutually authenticated connections, without requiring app code changes. (True)</p>
</li>
<li><p>Mutual authentication must be on or off for the entire cluster, gradual adoption is not possible. (False)</p>
</li>
</ol>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><p><a href="https://dzone.com/articles/tlsssl-terminology-and-basics" target="_blank">Basic TLS/SSL Terminology</a></p>
</li>
<li><p><a href="https://www.ibm.com/support/knowledgecenter/en/SSFKSJ_7.1.0/com.ibm.mq.doc/sy10660_.htm" target="_blank">TLS Handshake Explained</a></p>
</li>
<li><p><a href="https://istio.io/docs/tasks/security/mutual-tls.html" target="_blank">Istio Task</a></p>
</li>
<li><p><a href="https://istio.io/docs/concepts/security/mutual-tls.html" target="_blank">Istio Concept</a></p>
</li>
</ul>
<h2 id="continue-to-exercise-8---policy-enforcement"><a href="../exercise-8/">Continue to Exercise 8 - Policy Enforcement</a></h2>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../exercise-6/" class="navigation navigation-prev " aria-label="Previous page: Traffic Management">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../exercise-8/" class="navigation navigation-next " aria-label="Next page: Enforce policies for microservices">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Secure your service mesh","level":"1.1.7","depth":2,"next":{"title":"Enforce policies for microservices","level":"1.1.8","depth":2,"path":"exercise-8/README.md","ref":"exercise-8/README.md","articles":[]},"previous":{"title":"Traffic Management","level":"1.1.6","depth":2,"path":"exercise-6/README.md","ref":"exercise-6/README.md","articles":[]},"dir":"ltr"},"config":{"plugins":["livereload"],"root":"./workshop","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"exercise-7/README.md","mtime":"2018-12-04T14:26:03.142Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-12-04T14:50:20.706Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

